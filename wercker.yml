box: python:3.7.4-alpine

build:
  steps:
    - script:
        name: export django settings module
        code: |
          export DJANGO_SETTINGS_MODULE=ToDo.settings
    - script:
        name: Install psycopg2 dependencies
        code: apk update && \
              apk add --virtual build-deps gcc python-dev musl-dev && \
              apk add postgresql-dev && \
              apk add netcat-openbsd
    - script:
        name: Django apply migrations
        code: |
          python manage.py migrate
    - script:
        name: Django run tests
        code: |
          python manage.py test

deploy-staging:
  steps:
    - heroku-deploy:
        key: $HEROKU_KEY
        user: $HEROKU_USER
        app-name: $HEROKU_APP_NAME

    - script:
        name: Django apply migrations
        code: heroku run python manage.py migrate
