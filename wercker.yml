box: python:3.7-slim-buster
services:
    - id: mdillon/postgis
      env:
        POSTGRES_DB: postgres
        POSTGRES_USER: postgres
        POSTGRES_PASSWORD: qwerty1996

build:
  steps:
    - script:
        name: export django settings module
        code: |
          export DJANGO_SETTINGS_MODULE=ToDo.settings
    - script:
        name: install psycopg2 dependencies
        code: |
          apt-get update && apt-get install -y build-essential && apt-get install -y libpq-dev && apt-get -y install gdal-bin
    - script:
        name: pip install requirements
        code: |
          pip install -r requirements.txt
    - script:
        name: Django apply migrations
        code: |
          python manage.py migrate
    - script:
        name: Django run tests
        code: |
          python manage.py test

deploy-staging:
  steps:
    - heroku-deploy:
        key: $HEROKU_KEY
        key-name: HEROKU_KEY_PAIR
        user: $HEROKU_USER
        app-name: $HEROKU_APP_NAME
        install-toolbelt: true

    - script:
        name: Django apply migrations
        code: heroku run --app $HEROKU_APP_NAME python manage.py migrate
